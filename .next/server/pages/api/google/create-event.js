"use strict";(()=>{var e={};e.id=295,e.ids=[295],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},9993:e=>{e.exports=require("googleapis")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},3153:(e,t,r)=>{r.r(t),r.d(t,{config:()=>m,default:()=>f,routeModule:()=>_});var n={};r.r(n),r.d(n,{default:()=>c});var o=r(1802),a=r(7153),i=r(6249),s=r(9993),l=r(6719),u=r(3245),d=r(5290);async function c(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method Not Allowed"});let{orderId:r,startTime:n,laborToDo:o}=e.body;if(!r||!n||!o)return t.status(400).json({error:"Missing required fields."});try{let{data:e,error:a}=await u.O.from("system_settings").select("key, value");if(a)throw a;let i=e.find(e=>"google_refresh_token"===e.key)?.value,c=e.find(e=>"google_selected_calendar_id"===e.key)?.value;if(!i||!c)return t.status(401).json({error:"Google Calendar not configured."});l.s.setCredentials({refresh_token:i});let f=await (0,d.p)(o),m=new Date(new Date(n).getTime()+6e4*f).toISOString(),{data:_,error:g}=await u.O.from("customer_orders").select("customer_name, work_order_number").eq("id",r).single();if(g)throw g;let p=`Job: ${_.customer_name} (#${_.work_order_number})`,v=`Work Order: ${_.work_order_number}
Customer: ${_.customer_name}

Labor Details:
${o}`,h=s.google.calendar({version:"v3",auth:l.s}),w=await h.events.insert({calendarId:c,requestBody:{summary:p,description:v,start:{dateTime:n,timeZone:"America/Los_Angeles"},end:{dateTime:m,timeZone:"America/Los_Angeles"}}}),{error:y}=await u.O.from("customer_orders").update({google_calendar_event_id:w.data.id,scheduled_start_time:n,scheduled_end_time:m,status:"Scheduled"}).eq("id",r);if(y)throw y;t.status(200).json({message:"Event created successfully",event:w.data})}catch(e){console.error("Error creating calendar event:",e),t.status(500).json({error:"Failed to create calendar event."})}}let f=(0,i.l)(n,"default"),m=(0,i.l)(n,"config"),_=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/google/create-event",pathname:"/api/google/create-event",bundlePath:"",filename:""},userland:n})},6719:(e,t,r)=>{r.d(t,{s:()=>o});var n=r(9993);let o=new n.google.auth.OAuth2(process.env.GOOGLE_CLIENT_ID,process.env.GOOGLE_CLIENT_SECRET,process.env.GOOGLE_REDIRECT_URI);n.google.calendar({version:"v3",auth:o})},5290:(e,t,r)=>{r.d(t,{D:()=>s,p:()=>i});var n=r(3884),o=r(3245);async function a(){let{data:e,error:t}=await o.O.from("line_item_catalog").select("*").eq("active",!0);return t?(console.error("Supabase fetch error:",t),[]):e||[]}async function i(e){let t=(0,n.F)(e);if(!t.length)return 0;let r=await a();if(!r.length)return 0;let o=0;for(let e of t){let t=r.find(t=>e.description.toLowerCase().includes(t.code.toLowerCase()));t&&(o+=t.duration_minutes*e.quantity)}return o}async function s(e){let t=0,r=0,n=await a();for(let o of(n&&0!==n.length||(console.log("Line item catalog is empty. Fetching from Supabase..."),await a()),e)){let e=n.find(e=>e.code===o.description);e?(t+=(e.duration_minutes||0)*o.quantity,r+=(e.price||0)*o.quantity):console.warn(`[CATALOG_MISS] Line item code not found in catalog: "${o.description}"`)}return{durationMinutes:t,quote:r}}},3884:(e,t,r)=>{r.d(t,{F:()=>n});function n(e){return e?e.split(/\r?\n/).map(e=>e.trim()).filter(Boolean).map(e=>{let t=e.match(/Qty: ([\d.]+) - (.+)/i);return t?{quantity:parseFloat(t[1]),description:t[2].trim()}:null}).filter(Boolean):[]}},3245:(e,t,r)=>{r.d(t,{O:()=>i});var n=r(2885);let o="https://xrqbldnqjmyjnurlwvlt.supabase.co",a="sb_publishable_QEAQo0wNojYKriWfnyvfbQ_r8Cc1s37";if(!o||!a)throw Error("Supabase URL and anonymous key are required.");let i=(0,n.createClient)(o,a)},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=3153);module.exports=r})();